var e="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var t={};(function(){var o=new Date("2060-10-22"),r,i=0,s=2,n=3,a=4,p=5,u=10,d=20,l=30,h=[a,l],c=[i,s,u],f='"d41d8cd98f00b204e9800998ecf8427e"',m=2*60*1e3,g=["maxConcurrentParts","logging","cloudfront","encodeFilename","computeContentMd5","allowS3ExistenceOptimization","onlyRetryForSameFileName","timeUrl","cryptoMd5Method","cryptoHexEncodedHash256","awsRegion","awsSignatureVersion","evaporateChanged"],y={33:"%21",39:"%27",40:"%28",41:"%29",42:"%2A"},S;var Evaporate=function(t){(this||e).config=extend({readableStreams:false,readableStreamPartMethod:null,bucket:null,logging:true,maxConcurrentParts:5,partSize:6*1024*1024,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:1e3,cloudfront:false,s3Acceleration:false,mockLocalStorage:false,encodeFilename:true,computeContentMd5:false,allowS3ExistenceOptimization:false,onlyRetryForSameFileName:false,timeUrl:null,cryptoMd5Method:null,cryptoHexEncodedHash256:null,aws_key:null,awsRegion:"us-east-1",awsSignatureVersion:"4",sendCanonicalRequestToSignerUrl:false,s3FileCacheHoursAgo:null,signParams:{},signHeaders:{},customAuthMethod:void 0,maxFileSize:null,signResponseHandler:null,xhrWithCredentials:false,localTimeOffset:void 0,evaporateChanged:function(){},abortCompletionThrottlingMs:1e3},t);if("undefined"!==typeof window&&window.console){S=window.console;S.d=S.log;S.w=window.console.warn?S.warn:S.d;S.e=window.console.error?S.error:S.d}(this||e)._instantiationError=this.validateEvaporateOptions();if("string"!==typeof(this||e)._instantiationError){delete(this||e)._instantiationError;(this||e).config.logging||(S=noOpLogger());var o=new Date;r=new Date(o.setHours(o.getHours()-((this||e).config.s3FileCacheHoursAgo||-100)));if("number"===typeof t.localTimeOffset)(this||e).localTimeOffset=t.localTimeOffset;else{var i=this||e;Evaporate.getLocalTimeOffset((this||e).config).then((function(e){i.localTimeOffset=e}))}(this||e).pendingFiles={};(this||e).queuedFiles=[];(this||e).filesInProcess=[];v=new HistoryCache((this||e).config.mockLocalStorage)}else(this||e).supported=false};Evaporate.create=function(e){var t=extend({},e);return Evaporate.getLocalTimeOffset(t).then((function(e){t.localTimeOffset=e;return new Promise((function(e,o){var r=new Evaporate(t);true===r.supported?e(r):o(r._instantiationError)}))}))};Evaporate.getLocalTimeOffset=function(e){return new Promise((function(t,o){if("number"===typeof e.localTimeOffset)return t(e.localTimeOffset);if(e.timeUrl){var r=new XMLHttpRequest;r.open("GET",e.timeUrl+"?requestTime="+(new Date).getTime());r.onreadystatechange=function(){if(4===r.readyState&&200===r.status){var e=new Date(Date.parse(r.responseText)),o=e-new Date;S.d("localTimeOffset is",o,"ms");t(o)}};r.onerror=function(e){S.e("xhr error timeUrl",e);o("Fetching offset time failed with status: "+e.status)};r.send()}else t(0)}))};Evaporate.prototype.config={};Evaporate.prototype.localTimeOffset=0;Evaporate.prototype.supported=false;Evaporate.prototype._instantiationError=void 0;Evaporate.prototype.evaporatingCount=0;Evaporate.prototype.pendingFiles={};Evaporate.prototype.filesInProcess=[];Evaporate.prototype.queuedFiles=[];Evaporate.prototype.startNextFile=function(t){if((this||e).queuedFiles.length&&!((this||e).evaporatingCount>=(this||e).config.maxConcurrentParts)){var o=(this||e).queuedFiles.shift();if(o.status===i){S.d("Starting",decodeURIComponent(o.name),"reason:",t);this.evaporatingCnt(+1);o.start()}else{S.d("Requeued",decodeURIComponent(o.name),"status:",o.status,"reason:",t);(this||e).queuedFiles.push(o)}}};Evaporate.prototype.fileCleanup=function(t){removeAtIndex((this||e).queuedFiles,t);removeAtIndex((this||e).filesInProcess,t)&&this.evaporatingCnt(-1);t.done();this.consumeRemainingSlots()};Evaporate.prototype.queueFile=function(t){(this||e).filesInProcess.push(t);(this||e).queuedFiles.push(t);1===(this||e).filesInProcess.length&&this.startNextFile("first file")};Evaporate.prototype.add=function(t,o){var r=this||e,s;return new Promise((function(e,n){var a=extend(o,{});g.forEach((function(e){delete a[e]}));s=extend(r.config,a);if("undefined"===typeof t||"undefined"===typeof t.file)return n("Missing file");if(s.maxFileSize&&t.file.size>s.maxFileSize)return n("File size too large. Maximum size allowed is "+s.maxFileSize);if("undefined"===typeof t.name)return n("Missing attribute: name");s.encodeFilename&&(t.name=s3EncodedObjectName(t.name));var p=new FileUpload(extend({started:function(){},uploadInitiated:function(){},progress:function(){},complete:function(){},cancelled:function(){},paused:function(){},resumed:function(){},pausing:function(){},nameChanged:function(){},info:function(){},warn:function(){},error:function(){},beforeSigner:void 0,xAmzHeadersAtInitiate:{},notSignedHeadersAtInitiate:{},xAmzHeadersCommon:null,xAmzHeadersAtUpload:{},xAmzHeadersAtComplete:{}},t,{status:i,priority:0,loadedBytes:0,sizeBytes:t.file.size,eTag:""}),s,r),u=p.id;r.pendingFiles[u]=p;r.queueFile(p);p.deferredCompletion.promise.then((function(){r.fileCleanup(p);e(decodeURIComponent(p.name))}),(function(e){r.fileCleanup(p);n(e)}))}))};Evaporate.prototype.cancel=function(e){return"undefined"===typeof e?this._cancelAll():this._cancelOne(e)};Evaporate.prototype._cancelAll=function(){S.d("Canceling all file uploads");var t=[];for(var o in(this||e).pendingFiles)if((this||e).pendingFiles.hasOwnProperty(o)){var r=(this||e).pendingFiles[o];c.indexOf(r.status)>-1&&t.push(r.stop())}t.length||t.push(Promise.reject("No files to cancel."));return Promise.all(t)};Evaporate.prototype._cancelOne=function(t){var o=[];(this||e).pendingFiles[t]?o.push((this||e).pendingFiles[t].stop()):o.push(Promise.reject("File does not exist"));return Promise.all(o)};Evaporate.prototype.pause=function(e,t){t=t||{};var o="undefined"!==typeof t.force&&t.force;return"undefined"===typeof e?this._pauseAll(o):this._pauseOne(e,o)};Evaporate.prototype._pauseAll=function(t){S.d("Pausing all file uploads");var o=[];for(var r in(this||e).pendingFiles)if((this||e).pendingFiles.hasOwnProperty(r)){var i=(this||e).pendingFiles[r];c.indexOf(i.status)>-1&&this._pause(i,t,o)}return Promise.all(o)};Evaporate.prototype._pauseOne=function(t,o){var r=[],i=(this||e).pendingFiles[t];"undefined"===typeof i?r.push(Promise.reject("Cannot pause a file that has not been added.")):i.status===a&&r.push(Promise.reject("Cannot pause a file that is already paused."));r.length||this._pause(i,o,r);return Promise.all(r)};Evaporate.prototype._pause=function(t,o,r){r.push(t.pause(o));removeAtIndex((this||e).filesInProcess,t);removeAtIndex((this||e).queuedFiles,t)};Evaporate.prototype.resume=function(e){return"undefined"===typeof e?this._resumeAll():this._resumeOne(e)};Evaporate.prototype._resumeAll=function(){S.d("Resuming all file uploads");for(var t in(this||e).pendingFiles)if((this||e).pendingFiles.hasOwnProperty(t)){var o=(this||e).pendingFiles[t];h.indexOf(o.status)>-1&&this.resumeFile(o)}return Promise.resolve()};Evaporate.prototype._resumeOne=function(t){var o=(this||e).pendingFiles[t],r=[];"undefined"===typeof o?r.push(Promise.reject("Cannot pause a file that does not exist.")):-1===h.indexOf(o.status)?r.push(Promise.reject("Cannot resume a file that has not been paused.")):this.resumeFile(o);return Promise.all(r)};Evaporate.prototype.resumeFile=function(e){e.resume();this.queueFile(e)};Evaporate.prototype.forceRetry=function(){};Evaporate.prototype.consumeRemainingSlots=function(){var t=(this||e).config.maxConcurrentParts-(this||e).evaporatingCount;if(t)for(var o=0;o<(this||e).filesInProcess.length;o++){var r=(this||e).filesInProcess[o];var i=r.consumeSlots();if(!(i<0)){t-=i;if(!t)return}}};Evaporate.prototype.validateEvaporateOptions=function(){(this||e).supported=!("undefined"===typeof File||"undefined"===typeof Promise);if(!(this||e).supported)return"Evaporate requires support for File and Promise";if((this||e).config.readableStreams){if("function"!==typeof(this||e).config.readableStreamPartMethod)return"Option readableStreamPartMethod is required when readableStreams is set."}else if("undefined"===typeof Blob||"undefined"===typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice))return"Evaporate requires support for Blob [webkitSlice || mozSlice || slice]";if(!(this||e).config.signerUrl&&"function"!==typeof(this||e).config.customAuthMethod)return"Option signerUrl is required unless customAuthMethod is present.";if(!(this||e).config.bucket)return"The AWS 'bucket' option must be present.";if((this||e).config.computeContentMd5){(this||e).supported="undefined"!==typeof FileReader.prototype.readAsArrayBuffer;if(!(this||e).supported)return"The browser's FileReader object does not support readAsArrayBuffer";if("function"!==typeof(this||e).config.cryptoMd5Method)return"Option computeContentMd5 has been set but cryptoMd5Method is not defined.";if("4"===(this||e).config.awsSignatureVersion&&"function"!==typeof(this||e).config.cryptoHexEncodedHash256)return"Option awsSignatureVersion is 4 but cryptoHexEncodedHash256 is not defined."}else if("4"===(this||e).config.awsSignatureVersion)return"Option awsSignatureVersion is 4 but computeContentMd5 is not enabled.";return true};Evaporate.prototype.evaporatingCnt=function(t){(this||e).evaporatingCount=Math.max(0,(this||e).evaporatingCount+t);(this||e).config.evaporateChanged(this||e,(this||e).evaporatingCount)};function FileUpload(t,o,r){(this||e).fileTotalBytesUploaded=0;(this||e).s3Parts=[];(this||e).partsOnS3=[];(this||e).partsInProcess=[];(this||e).partsToUpload=[];(this||e).numParts=-1;(this||e).con=extend({},o);(this||e).evaporate=r;(this||e).localTimeOffset=r.localTimeOffset;(this||e).deferredCompletion=defer();extend(this||e,t);(this||e).id=decodeURIComponent((this||e).con.bucket+"/"+(this||e).name);(this||e).signParams=o.signParams}FileUpload.prototype.con=void 0;FileUpload.prototype.evaporate=void 0;FileUpload.prototype.localTimeOffset=0;FileUpload.prototype.id=void 0;FileUpload.prototype.status=i;FileUpload.prototype.numParts=-1;FileUpload.prototype.fileTotalBytesUploaded=0;FileUpload.prototype.partsInProcess=[];FileUpload.prototype.partsToUpload=[];FileUpload.prototype.s3Parts=[];FileUpload.prototype.partsOnS3=[];FileUpload.prototype.deferredCompletion=void 0;FileUpload.prototype.abortedByUser=false;FileUpload.prototype.progressInterval=void 0;FileUpload.prototype.startTime=void 0;FileUpload.prototype.loaded=0;FileUpload.prototype.totalUploaded=0;FileUpload.prototype.updateLoaded=function(t){(this||e).loaded+=t;(this||e).fileTotalBytesUploaded+=t};FileUpload.prototype.progessStats=function(){if(0===(this||e).fileTotalBytesUploaded)return{speed:0,readableSpeed:"",loaded:0,totalUploaded:0,remainingSize:(this||e).sizeBytes,secondsLeft:-1,fileSize:(this||e).sizeBytes};(this||e).totalUploaded+=(this||e).loaded;var t=(new Date-(this||e).startTime)/1e3,o=(this||e).totalUploaded/t,r=(this||e).sizeBytes-(this||e).fileTotalBytesUploaded,i={speed:o,readableSpeed:readableFileSize(o),loaded:(this||e).loaded,totalUploaded:(this||e).fileTotalBytesUploaded,remainingSize:r,secondsLeft:-1,fileSize:(this||e).sizeBytes};o>0&&(i.secondsLeft=Math.round(r/o));return i};FileUpload.prototype.onProgress=function(){if(-1===[d,a].indexOf((this||e).status)){this.progress((this||e).fileTotalBytesUploaded/(this||e).sizeBytes,this.progessStats());(this||e).loaded=0}};FileUpload.prototype.startMonitor=function(){clearInterval((this||e).progressInterval);(this||e).startTime=new Date;(this||e).loaded=0;(this||e).totalUploaded=0;this.onProgress();(this||e).progressInterval=setInterval((this||e).onProgress.bind(this||e),(this||e).con.progressIntervalMS)};FileUpload.prototype.stopMonitor=function(){clearInterval((this||e).progressInterval)};FileUpload.prototype.startNextFile=function(t){(this||e).evaporate.startNextFile(t)};FileUpload.prototype.evaporatingCnt=function(t){(this||e).evaporate.evaporatingCnt(t)};FileUpload.prototype.consumeRemainingSlots=function(){(this||e).evaporate.consumeRemainingSlots()};FileUpload.prototype.getRemainingSlots=function(){var t=(this||e).evaporate.evaporatingCount;!(this||e).partsInProcess.length&&t>0&&(t-=1);return(this||e).con.maxConcurrentParts-t};FileUpload.prototype.lastPartSatisfied=Promise.resolve("onStart");FileUpload.prototype.start=function(){(this||e).status=s;this.startMonitor();this.started((this||e).id);if((this||e).uploadId){S.d("resuming FileUpload ",(this||e).id);return this.consumeSlots()}var t=(this||e).name;this.getUnfinishedFileUpload();var o=(this||e).con.computeContentMd5&&(this||e).con.allowS3ExistenceOptimization&&"undefined"!==typeof(this||e).firstMd5Digest&&"undefined"!==typeof(this||e).eTag;if((this||e).uploadId){if(o)return this.reuseS3Object(t).then((this||e).deferredCompletion.resolve).catch((this||e).uploadFileFromScratch.bind(this||e));this.resumeInterruptedUpload().then((this||e)._uploadComplete.bind(this||e)).catch((this||e).uploadFileFromScratch.bind(this||e))}else this.uploadFileFromScratch("")};FileUpload.prototype.uploadFileFromScratch=function(t){if(-1!==c.indexOf((this||e).status)){S.d(t);(this||e).uploadId=void 0;return this.uploadFile((this||e).name).then((this||e)._uploadComplete.bind(this||e)).catch((this||e)._abortUpload.bind(this||e))}};FileUpload.prototype._uploadComplete=function(){this.completeUpload().then((this||e).deferredCompletion.resolve)};FileUpload.prototype.stop=function(){S.d("stopping FileUpload ",(this||e).id);this.setStatus(p);this.info("Canceling uploads...");(this||e).abortedByUser=true;var t=this||e;return this.abortUpload().then((function(){throw"User aborted the upload"})).catch((function(e){t.deferredCompletion.reject(e)}))};FileUpload.prototype.pause=function(t){S.d("pausing FileUpload, force:",!!t,(this||e).id);var o=[];this.info("Pausing uploads...");(this||e).status=l;if(t)this.abortParts(true);else{o=(this||e).partsInProcess.map((function(t){return(this||e).s3Parts[t].awsRequest.awsDeferred.promise}),this||e);this.pausing()}return Promise.all(o).then(function(){this.stopMonitor();(this||e).status=a;this.startNextFile("pause");this.paused()}.bind(this||e))};FileUpload.prototype.resume=function(){(this||e).status=i;this.resumed()};FileUpload.prototype.done=function(){clearInterval((this||e).progressInterval);this.startNextFile("file done");(this||e).partsOnS3=[];(this||e).s3Parts=[]};FileUpload.prototype._startCompleteUpload=function(t){return function(){var o=t?this.completeUpload():Promise.resolve();o.then((this||e).deferredCompletion.resolve.bind(this||e))}};FileUpload.prototype._abortUpload=function(){if(!(this||e).abortedByUser){var t=this||e;this.abortUpload().then((function(){t.deferredCompletion.reject("File upload aborted due to a part failing to upload")}),(this||e).deferredCompletion.reject.bind(this||e))}};FileUpload.prototype.abortParts=function(t){var o=this||e;var r=(this||e).partsInProcess.slice(0);r.forEach((function(e){var r=o.s3Parts[e];if(r){r.awsRequest.abort();t&&(r.status=i);removeAtIndex(o.partsInProcess,r.partNumber);o.partsToUpload.length&&o.evaporatingCnt(-1)}}))};FileUpload.prototype.makeParts=function(t){(this||e).numParts=Math.ceil((this||e).sizeBytes/(this||e).con.partSize)||1;var o=[];var r=this||e;function cleanUpAfterPart(e){removeAtIndex(r.partsToUpload,e.partNumber);removeAtIndex(r.partsInProcess,e.partNumber);r.partsToUpload.length&&r.evaporatingCnt(-1)}function resolve(e){return function(){cleanUpAfterPart(e);r.partsToUpload.length&&r.consumeRemainingSlots();r.partsToUpload.length<r.con.maxConcurrentParts&&r.startNextFile("part resolve")}}function reject(e){return function(){cleanUpAfterPart(e)}}var s=t?1:(this||e).numParts;for(var a=1;a<=s;a++){var p=(this||e).s3Parts[a];if("undefined"!==typeof p){if(p.status===n)continue}else p=this.makePart(a,i,(this||e).sizeBytes);p.awsRequest=new PutPart(this||e,p);p.awsRequest.awsDeferred.promise.then(resolve(p),reject(p));(this||e).partsToUpload.push(a);o.push((this||e).s3Parts[a].awsRequest.awsDeferred.promise)}return o};FileUpload.prototype.makePart=function(t,o,r){var i={status:o,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===r,md5_digest:null,partNumber:t};(this||e).s3Parts[t]=i;return i};FileUpload.prototype.setStatus=function(t){(this||e).status=t};FileUpload.prototype.createUploadFile=function(){if((this||e).status!==d){var t=uploadKey(this||e),o={awsKey:(this||e).name,bucket:(this||e).con.bucket,uploadId:(this||e).uploadId,fileSize:(this||e).sizeBytes,fileType:(this||e).file.type,lastModifiedDate:dateISOString((this||e).file.lastModified),partSize:(this||e).con.partSize,signParams:(this||e).con.signParams,createdAt:(new Date).toISOString()};saveUpload(t,o)}};FileUpload.prototype.updateUploadFile=function(t){var o=uploadKey(this||e),r=getSavedUploads(),i=extend({},r[o],t);saveUpload(o,i)};FileUpload.prototype.completeUploadFile=function(t){var o=getSavedUploads(),r=o[uploadKey(this||e)];if("undefined"!==typeof r){r.completedAt=(new Date).toISOString();r.eTag=(this||e).eTag;r.firstMd5Digest=(this||e).firstMd5Digest;o[uploadKey(this||e)]=r;v.setItem("awsUploads",JSON.stringify(o))}this.complete(t,(this||e).name,this.progessStats());this.setStatus(n);this.onProgress()};FileUpload.prototype.removeUploadFile=function(){"undefined"!==typeof(this||e).file&&removeUpload(uploadKey(this||e))};FileUpload.prototype.getUnfinishedFileUpload=function(){var t=getSavedUploads(true),o=t[uploadKey(this||e)];if(this.canRetryUpload(o)){(this||e).uploadId=o.uploadId;(this||e).name=o.awsKey;(this||e).eTag=o.eTag;(this||e).firstMd5Digest=o.firstMd5Digest;(this||e).signParams=o.signParams}};FileUpload.prototype.canRetryUpload=function(t){if("undefined"===typeof t)return false;var i=new Date(t.completedAt||o);return(this||e).con.partSize===t.partSize&&i>r&&(this||e).con.bucket===t.bucket&&(!(this||e).con.onlyRetryForSameFileName||(this||e).name===t.awsKey)};FileUpload.prototype.partSuccess=function(t,o){var r=o.part;S.d(o.request.step,"ETag:",t);if(r.isEmpty||t!==f){r.eTag=t;r.status=n;(this||e).partsOnS3.push(r);return true}r.status=u;o.resetLoadedBytes();var i=["eTag matches MD5 of 0 length blob for part #",o.partNumber,"Retrying part."].join(" ");S.w(i);this.warn(i)};FileUpload.prototype.listPartsSuccess=function(t,o){this.info("uploadId",(this||e).uploadId,"is not complete. Fetching parts from part marker",t.partNumberMarker);o=o.replace(/(\r\n|\n|\r)/gm,"");var r=/<Part>(.+?)<\/Part\>/g;while(true){var i=(r.exec(o)||[])[1];if(!i)break;var s=parseInt(elementText(i,"Size"),10);(this||e).fileTotalBytesUploaded+=s;(this||e).partsOnS3.push({eTag:elementText(i,"ETag").replace(/&quot;/g,'"'),partNumber:parseInt(elementText(i,"PartNumber"),10),size:s,LastModified:elementText(i,"LastModified")})}return"true"===elementText(o,"IsTruncated")?elementText(o,"NextPartNumberMarker"):void 0};FileUpload.prototype.makePartsfromPartsOnS3=function(){if(-1!==c.indexOf((this||e).status)){this.nameChanged((this||e).name);(this||e).partsOnS3.forEach(function(e){var t=this.makePart(e.partNumber,n,e.size);t.eTag=e.eTag;t.loadedBytes=e.size;t.loadedBytesPrevious=e.size;t.finishedUploadingAt=e.LastModified}.bind(this||e))}};FileUpload.prototype.completeUpload=function(){var t=this||e;return new CompleteMultipartUpload(this||e).send().then((function(e){t.eTag=elementText(e.responseText,"ETag").replace(/&quot;/g,'"');t.completeUploadFile(e)}))};FileUpload.prototype.getCompletedPayload=function(){var t=[];t.push("<CompleteMultipartUpload>");(this||e).s3Parts.forEach((function(e,o){o>0&&["<Part><PartNumber>",o,"</PartNumber><ETag>",e.eTag,"</ETag></Part>"].forEach((function(e){t.push(e)}))}));t.push("</CompleteMultipartUpload>");return t.join("")};FileUpload.prototype.consumeSlots=function(){if(0===(this||e).partsToUpload.length)return-1;if((this||e).partsToUpload.length!==(this||e).partsInProcess.length&&(this||e).status===s){var t=Math.min(this.getRemainingSlots(),(this||e).partsToUpload.length);if(!t)return-1;var o=0;for(var r=0;r<(this||e).partsToUpload.length;r++){var i=(this||e).s3Parts[(this||e).partsToUpload[r]];if(i.status!==s&&this.canStartPart(i)){(this||e).partsInProcess.length&&(this||e).partsToUpload.length>1&&this.evaporatingCnt(+1);(this||e).partsInProcess.push(i.partNumber);var n=i.awsRequest;(this||e).lastPartSatisfied.then(n.delaySend.bind(n));(this||e).lastPartSatisfied=n.getStartedPromise();o+=1;if(o===t)break}}var a=(this||e).partsToUpload.length===(this||e).partsInProcess.length,p=this.getRemainingSlots();a&&p>0&&this.startNextFile("consume slots");return p}return 0};FileUpload.prototype.canStartPart=function(t){return-1===(this||e).partsInProcess.indexOf(t.partNumber)&&!t.awsRequest.errorExceptionStatus()};FileUpload.prototype.uploadFile=function(t){this.removeUploadFile();var o=this||e;return new InitiateMultipartUpload(o,t).send().then((function(){o.uploadInitiated(o.uploadId);o.partsToUpload=[];return o.uploadParts().then((function(){}),(function(e){throw e}))}))};FileUpload.prototype.uploadParts=function(){(this||e).loaded=0;(this||e).totalUploaded=0;if(-1===c.indexOf((this||e).status))return Promise.reject("Part uploading stopped because the file was canceled");var t=this.makeParts();this.setStatus(s);(this||e).startTime=new Date;this.consumeSlots();return Promise.all(t)};FileUpload.prototype.abortUpload=function(){return new Promise(function(t,o){"undefined"!==typeof(this||e).uploadId?new DeleteMultipartUpload(this||e).send().then(t,o):t()}.bind(this||e)).then(function(){this.setStatus(d);this.cancelled();this.removeUploadFile()}.bind(this||e),(this||e).deferredCompletion.reject.bind(this||e))};FileUpload.prototype.resumeInterruptedUpload=function(){return new ResumeInterruptedUpload(this||e).send().then((this||e).uploadParts.bind(this||e))};FileUpload.prototype.reuseS3Object=function(t){var o=this||e;this.makeParts(1);(this||e).partsToUpload=[];var r=(this||e).s3Parts[1];function reject(e){o.name=t;throw e}return r.awsRequest.getPartMd5Digest().then((function(){if(o.firstMd5Digest===r.md5_digest)return new ReuseS3Object(o,t).send().then((function(e){S.d("headObject found matching object on S3.");o.completeUploadFile(e);o.nameChanged(o.name)})).catch(reject);var e=o.con.allowS3ExistenceOptimization?"File's first part MD5 digest does not match what was stored.":"allowS3ExistenceOptimization is not enabled.";reject(e)}))};function SignedS3AWSRequest(t,o){(this||e).fileUpload=t;(this||e).con=t.con;(this||e).attempts=1;(this||e).localTimeOffset=(this||e).fileUpload.localTimeOffset;(this||e).awsDeferred=defer();(this||e).started=defer();(this||e).awsUrl=awsUrl((this||e).con);(this||e).awsHost=uri((this||e).awsUrl).hostname;var r=extend({},o);t.contentType&&(r.contentType=t.contentType);this.updateRequest(r)}SignedS3AWSRequest.prototype.fileUpload=void 0;SignedS3AWSRequest.prototype.con=void 0;SignedS3AWSRequest.prototype.awsUrl=void 0;SignedS3AWSRequest.prototype.awsHost=void 0;SignedS3AWSRequest.prototype.authorize=function(){};SignedS3AWSRequest.prototype.localTimeOffset=0;SignedS3AWSRequest.prototype.awsDeferred=void 0;SignedS3AWSRequest.prototype.started=void 0;SignedS3AWSRequest.prototype.getPath=function(){var t="/"+(this||e).con.bucket+"/"+(this||e).fileUpload.name;((this||e).con.cloudfront||(this||e).awsUrl.indexOf("cloudfront")>-1)&&(t="/"+(this||e).fileUpload.name);return t};SignedS3AWSRequest.prototype.updateRequest=function(t){(this||e).request=t;var o=signingVersion(this||e,S);(this||e).signer=new o(t)};SignedS3AWSRequest.prototype.success=function(){(this||e).awsDeferred.resolve((this||e).currentXhr)};SignedS3AWSRequest.prototype.backOffWait=function(){return 1===(this||e).attempts?0:1e3*Math.min((this||e).con.maxRetryBackoffSecs,Math.pow((this||e).con.retryBackoffPower,(this||e).attempts-2))};SignedS3AWSRequest.prototype.error=function(t){if(!this.errorExceptionStatus()){(this||e).signer.error();S.d((this||e).request.step,"error:",(this||e).fileUpload.id,t);if("undefined"===typeof this.errorHandler(t)){(this||e).fileUpload.warn("Error in ",(this||e).request.step,t);(this||e).fileUpload.setStatus(u);var o=this||e,r=this.backOffWait();(this||e).attempts+=1;setTimeout((function(){o.errorExceptionStatus()||o.trySend()}),r)}}};SignedS3AWSRequest.prototype.errorHandler=function(){};SignedS3AWSRequest.prototype.errorExceptionStatus=function(){return false};SignedS3AWSRequest.prototype.getPayload=function(){return Promise.resolve(null)};SignedS3AWSRequest.prototype.success_status=function(t){return t.status>=200&&t.status<=299||(this||e).request.success404&&404===t.status};SignedS3AWSRequest.prototype.stringToSign=function(){return encodeURIComponent((this||e).signer.stringToSign())};SignedS3AWSRequest.prototype.canonicalRequest=function(){return(this||e).signer.canonicalRequest()};SignedS3AWSRequest.prototype.signResponse=function(t,o,r){var i=this||e;return new Promise((function(e){if("function"===typeof i.con.signResponseHandler)return i.con.signResponseHandler(t,o,r).then(e);e(t)}))};SignedS3AWSRequest.prototype.sendRequestToAWS=function(){var t=this||e;return new Promise((function(e,o){var r=new XMLHttpRequest;t.currentXhr=r;var i=[t.awsUrl,t.getPath(),t.request.path].join(""),s={};t.request.query_string&&(i+=t.request.query_string);extend(s,t.request.not_signed_headers);extend(s,t.request.x_amz_headers);r.onreadystatechange=function(){if(4===r.readyState)if(t.success_status(r))t.request.response_match&&void 0===r.response.match(new RegExp(t.request.response_match))?o("AWS response does not match set pattern: "+t.request.response_match):e();else{var i=r.responseText?getAwsResponse(r):" ";i+="status:"+r.status;o(i)}};r.open(t.request.method,i);r.setRequestHeader("Authorization",t.signer.authorizationString());for(var n in s)s.hasOwnProperty(n)&&r.setRequestHeader(n,s[n]);t.signer.setHeaders(r);t.request.contentType&&r.setRequestHeader("Content-Type",t.request.contentType);t.request.md5_digest&&r.setRequestHeader("Content-MD5",t.request.md5_digest);r.onerror=function(e){var t=e.responseText?getAwsResponse(e):"transport error";o(t)};"function"===typeof t.request.onProgress&&(r.upload.onprogress=t.request.onProgress);t.getPayload().then(r.send.bind(r),o);setTimeout((function(){t.started.resolve("request sent "+t.request.step)}),20);t.signer.payload=null;t.payloadPromise=void 0}))};SignedS3AWSRequest.prototype.authorize=function(){(this||e).request.dateString=(this||e).signer.dateString((this||e).localTimeOffset);(this||e).request.x_amz_headers=extend((this||e).request.x_amz_headers,{"x-amz-date":(this||e).request.dateString});return(this||e).signer.getPayload().then(function(){return authorizationMethod(this||e).authorize()}.bind(this||e))};SignedS3AWSRequest.prototype.authorizationSuccess=function(t){S.d((this||e).request.step,"signature:",t);(this||e).request.auth=t};SignedS3AWSRequest.prototype.trySend=function(){var t=this||e;return this.authorize().then((function(e){t.authorizationSuccess(e);t.fileUpload.status!==d&&t.sendRequestToAWS().then(t.success.bind(t),t.error.bind(t))}),t.error.bind(t))};SignedS3AWSRequest.prototype.send=function(){this.trySend();return(this||e).awsDeferred.promise};function CancelableS3AWSRequest(t,o){SignedS3AWSRequest.call(this||e,t,o)}CancelableS3AWSRequest.prototype=Object.create(SignedS3AWSRequest.prototype);CancelableS3AWSRequest.prototype.constructor=CancelableS3AWSRequest;CancelableS3AWSRequest.prototype.errorExceptionStatus=function(){return[d,p].indexOf((this||e).fileUpload.status)>-1};function SignedS3AWSRequestWithRetryLimit(t,o,r){r>-1&&((this||e).maxRetries=r);SignedS3AWSRequest.call(this||e,t,o)}SignedS3AWSRequestWithRetryLimit.prototype=Object.create(CancelableS3AWSRequest.prototype);SignedS3AWSRequestWithRetryLimit.prototype.constructor=SignedS3AWSRequestWithRetryLimit;SignedS3AWSRequestWithRetryLimit.prototype.maxRetries=1;SignedS3AWSRequestWithRetryLimit.prototype.errorHandler=function(t){if((this||e).attempts>(this||e).maxRetries){var o=["MaxRetries exceeded. Will re-upload file id ",(this||e).fileUpload.id,", ",t].join("");S.w(o);(this||e).awsDeferred.reject(o);return true}};SignedS3AWSRequestWithRetryLimit.prototype.rejectedSuccess=function(){var t=Array.prototype.slice.call(arguments,1).join("");(this||e).awsDeferred.reject(t);return false};function InitiateMultipartUpload(t,o){var r={method:"POST",path:"?uploads",step:"initiate",x_amz_headers:t.xAmzHeadersAtInitiate,not_signed_headers:t.notSignedHeadersAtInitiate,response_match:"<UploadId>(.+)</UploadId>"};CancelableS3AWSRequest.call(this||e,t,r);(this||e).awsKey=o}InitiateMultipartUpload.prototype=Object.create(CancelableS3AWSRequest.prototype);InitiateMultipartUpload.prototype.constructor=InitiateMultipartUpload;InitiateMultipartUpload.prototype.success=function(){var t=(this||e).currentXhr.response.match(new RegExp((this||e).request.response_match));(this||e).fileUpload.uploadId=t[1];(this||e).fileUpload.awsKey=(this||e).awsKey;S.d("InitiateMultipartUpload ID is",(this||e).fileUpload.uploadId);(this||e).fileUpload.createUploadFile();(this||e).awsDeferred.resolve((this||e).currentXhr)};function CompleteMultipartUpload(t){t.info("will attempt to complete upload");var o={method:"POST",contentType:"application/xml; charset=UTF-8",path:"?uploadId="+t.uploadId,x_amz_headers:t.xAmzHeadersCommon||t.xAmzHeadersAtComplete,step:"complete"};CancelableS3AWSRequest.call(this||e,t,o)}CompleteMultipartUpload.prototype=Object.create(CancelableS3AWSRequest.prototype);CompleteMultipartUpload.prototype.constructor=CompleteMultipartUpload;CompleteMultipartUpload.prototype.getPayload=function(){return Promise.resolve((this||e).fileUpload.getCompletedPayload())};function ReuseS3Object(t,o){(this||e).awsKey=o;t.info("will attempt to verify existence of the file");var r={method:"HEAD",path:"",x_amz_headers:t.xAmzHeadersCommon,success404:true,step:"head_object"};SignedS3AWSRequestWithRetryLimit.call(this||e,t,r)}ReuseS3Object.prototype=Object.create(SignedS3AWSRequestWithRetryLimit.prototype);ReuseS3Object.prototype.constructor=ReuseS3Object;ReuseS3Object.prototype.awsKey=void 0;ReuseS3Object.prototype.success=function(){var t=(this||e).currentXhr.getResponseHeader("Etag");(t===(this||e).fileUpload.eTag||this.rejectedSuccess("uploadId ",(this||e).fileUpload.id," found on S3 but the Etag doesn't match."))&&(this||e).awsDeferred.resolve((this||e).currentXhr)};function ResumeInterruptedUpload(t){SignedS3AWSRequestWithRetryLimit.call(this||e,t);this.updateRequest(this.setupRequest(0))}ResumeInterruptedUpload.prototype=Object.create(SignedS3AWSRequestWithRetryLimit.prototype);ResumeInterruptedUpload.prototype.constructor=ResumeInterruptedUpload;ResumeInterruptedUpload.prototype.awsKey=void 0;ResumeInterruptedUpload.prototype.partNumberMarker=0;ResumeInterruptedUpload.prototype.setupRequest=function(t){var o=["setupRequest() for uploadId:",(this||e).fileUpload.uploadId,"for part marker:",t].join(" ");S.d(o);(this||e).fileUpload.info(o);(this||e).awsKey=(this||e).fileUpload.name;(this||e).partNumberMarker=t;var r={method:"GET",path:["?uploadId=",(this||e).fileUpload.uploadId].join(""),query_string:"&part-number-marker="+t,x_amz_headers:(this||e).fileUpload.xAmzHeadersCommon,step:"get upload parts",success404:true};(this||e).request=r;return r};ResumeInterruptedUpload.prototype.success=function(){if(404!==(this||e).currentXhr.status){var t=(this||e).fileUpload.listPartsSuccess(this||e,(this||e).currentXhr.responseText);if(t){var o=this.setupRequest(t);this.updateRequest(o);this.trySend()}else{(this||e).fileUpload.makePartsfromPartsOnS3();(this||e).awsDeferred.resolve((this||e).currentXhr)}}else this.rejectedSuccess("uploadId ",(this||e).fileUpload.id," not found on S3.")&&(this||e).awsDeferred.resolve((this||e).currentXhr)};function PutPart(t,o){(this||e).part=o;(this||e).partNumber=o.partNumber;(this||e).start=((this||e).partNumber-1)*t.con.partSize;(this||e).end=Math.min((this||e).partNumber*t.con.partSize,t.sizeBytes);var r={method:"PUT",path:"?partNumber="+(this||e).partNumber+"&uploadId="+t.uploadId,step:"upload #"+(this||e).partNumber,x_amz_headers:t.xAmzHeadersCommon||t.xAmzHeadersAtUpload,contentSha256:"UNSIGNED-PAYLOAD",onProgress:(this||e).onProgress.bind(this||e)};SignedS3AWSRequest.call(this||e,t,r)}PutPart.prototype=Object.create(SignedS3AWSRequest.prototype);PutPart.prototype.constructor=PutPart;PutPart.prototype.part=1;PutPart.prototype.payloadPromise=void 0;PutPart.prototype.start=0;PutPart.prototype.end=0;PutPart.prototype.partNumber=void 0;PutPart.prototype.getPartMd5Digest=function(){var t=this||e,o=(this||e).part;return new Promise((function(e,r){t.con.computeContentMd5&&!o.md5_digest?t.getPayload().then((function(o){var r=t.con.cryptoMd5Method(o);if(1===t.partNumber&&t.con.computeContentMd5&&"undefined"===typeof t.fileUpload.firstMd5Digest){t.fileUpload.firstMd5Digest=r;t.fileUpload.updateUploadFile({firstMd5Digest:r})}e(r)}),r):e(o.md5_digest)})).then((function(e){if(e){S.d(t.request.step,"MD5 digest:",e);t.request.md5_digest=e;t.part.md5_digest=e}}))};PutPart.prototype.sendRequestToAWS=function(){(this||e).stalledInterval=setInterval(this.stalledPartMonitor(),m);this.stalledPartMonitor();return SignedS3AWSRequest.prototype.sendRequestToAWS.call(this||e)};PutPart.prototype.send=function(){if((this||e).part.status!==n&&-1===[d,a,p].indexOf((this||e).fileUpload.status)){S.d("uploadPart #",(this||e).partNumber,1===(this||e).attempts?"submitting":"retrying");(this||e).part.status=s;(this||e).attempts+=1;(this||e).part.loadedBytesPrevious=null;var t=this||e;return this.getPartMd5Digest().then((function(){S.d("Sending",t.request.step);SignedS3AWSRequest.prototype.send.call(t)}))}};PutPart.prototype.success=function(){clearInterval((this||e).stalledInterval);var t=(this||e).currentXhr.getResponseHeader("ETag");(this||e).currentXhr=null;(this||e).fileUpload.partSuccess(t,this||e)&&(this||e).awsDeferred.resolve((this||e).currentXhr)};PutPart.prototype.onProgress=function(t){if(t.loaded>0){var o=t.loaded-(this||e).part.loadedBytes;if(o){(this||e).part.loadedBytes=t.loaded;(this||e).fileUpload.updateLoaded(o)}}};PutPart.prototype.stalledPartMonitor=function(){var t=(this||e).part.loadedBytes;var o=this||e;return function(){clearInterval(o.stalledInterval);if(-1===[s,u,l,a].indexOf(o.fileUpload.status)&&o.part.status!==d&&o.part.loadedBytes<(this||e).size)if(t===o.part.loadedBytes){S.w("Part stalled. Will abort and retry:",o.partNumber,decodeURIComponent(o.fileUpload.name));o.abort();o.errorExceptionStatus()||o.delaySend()}else o.stalledInterval=setInterval(o.stalledPartMonitor(),m)}};PutPart.prototype.resetLoadedBytes=function(){(this||e).fileUpload.updateLoaded(-(this||e).part.loadedBytes);(this||e).part.loadedBytes=0;(this||e).fileUpload.onProgress()};PutPart.prototype.errorExceptionStatus=function(){return[p,d,a,l].indexOf((this||e).fileUpload.status)>-1};PutPart.prototype.delaySend=function(){var t=this.backOffWait();(this||e).attempts+=1;setTimeout((this||e).send.bind(this||e),t)};PutPart.prototype.errorHandler=function(t){clearInterval((this||e).stalledInterval);if(t.match(/status:404/)){var o="404 error on part PUT. The part and the file will abort. "+t;S.w(o);(this||e).fileUpload.error(o);(this||e).part.status=d;(this||e).awsDeferred.reject(o);return true}this.resetLoadedBytes();(this||e).part.status=u;this.errorExceptionStatus()||this.delaySend();return true};PutPart.prototype.abort=function(){(this||e).currentXhr&&(this||e).currentXhr.abort();this.resetLoadedBytes();(this||e).attempts=1};PutPart.size=0;PutPart.prototype.streamToArrayBuffer=function(t){return new Promise(function(o,r){if(!t.readable)return o([]);var i=new Uint8Array(Math.min((this||e).con.partSize,(this||e).end-(this||e).start)),s=0;t.on("data",onData);t.on("end",onEnd);t.on("error",onEnd);t.on("close",onClose);function onData(e){if(1!==e.byteLength){i.set(e,s);s+=e.byteLength}}function onEnd(e){e?r(e):o(i);cleanup()}function onClose(){o(i);cleanup()}function cleanup(){i=null;t.removeListener("data",onData);t.removeListener("end",onEnd);t.removeListener("error",onEnd);t.removeListener("close",onClose)}}.bind(this||e))};PutPart.prototype.getPayload=function(){"undefined"===typeof(this||e).payloadPromise&&((this||e).payloadPromise=(this||e).con.readableStreams?this.payloadFromStream():this.payloadFromBlob());return(this||e).payloadPromise};PutPart.prototype.payloadFromStream=function(){var t=(this||e).con.readableStreamPartMethod((this||e).fileUpload.file,(this||e).start,(this||e).end-1);return new Promise(function(o,r){var i=this.streamToArrayBuffer(t);i.then(function(e){o(e)}.bind(this||e),r)}.bind(this||e))};PutPart.prototype.payloadFromBlob=function(){var t=(this||e).fileUpload.file,o=t.slice?"slice":t.mozSlice?"mozSlice":"webkitSlice",r=t[o]((this||e).start,(this||e).end);return(this||e).con.computeContentMd5?new Promise((function(t){var o=new FileReader;o.onloadend=function(){var o=(this||e).result&&"undefined"!==typeof(this||e).result.buffer,r=o?new Uint8Array((this||e).result.buffer):(this||e).result;t(r)};o.readAsArrayBuffer(r)})):Promise.resolve(r)};PutPart.prototype.stalledInterval=-1;PutPart.prototype.getStartedPromise=function(){return(this||e).started.promise};function DeleteMultipartUpload(t){t.info("will attempt to abort the upload");t.abortParts();var o={method:"DELETE",path:"?uploadId="+t.uploadId,x_amz_headers:t.xAmzHeadersCommon,success404:true,step:"abort"};SignedS3AWSRequest.call(this||e,t,o)}DeleteMultipartUpload.prototype=Object.create(SignedS3AWSRequest.prototype);DeleteMultipartUpload.prototype.constructor=DeleteMultipartUpload;DeleteMultipartUpload.prototype.maxRetries=1;DeleteMultipartUpload.prototype.success=function(){(this||e).fileUpload.setStatus(d);(this||e).awsDeferred.resolve((this||e).currentXhr)};DeleteMultipartUpload.prototype.errorHandler=function(t){if((this||e).attempts>(this||e).maxRetries){var o="Error aborting upload, Exceeded retries deleting the file upload: "+t;S.w(o);(this||e).fileUpload.error(o);(this||e).awsDeferred.reject(o);return true}};function signingVersion(t,o){var r=t.con;function AwsSignature(t){(this||e).request=t}AwsSignature.prototype.request={};AwsSignature.prototype.error=function(){};AwsSignature.prototype.authorizationString=function(){};AwsSignature.prototype.stringToSign=function(){};AwsSignature.prototype.canonicalRequest=function(){};AwsSignature.prototype.setHeaders=function(){};AwsSignature.prototype.datetime=function(e){return new Date((new Date).getTime()+e)};AwsSignature.prototype.dateString=function(e){return this.datetime(e).toISOString().slice(0,19).replace(/-|:/g,"")+"Z"};function AwsSignatureV2(t){AwsSignature.call(this||e,t)}AwsSignatureV2.prototype=Object.create(AwsSignature.prototype);AwsSignatureV2.prototype.constructor=AwsSignatureV2;AwsSignatureV2.prototype.authorizationString=function(){return["AWS ",r.aws_key,":",(this||e).request.auth].join("")};AwsSignatureV2.prototype.stringToSign=function(){var i="",s,n=[];for(var a in(this||e).request.x_amz_headers)(this||e).request.x_amz_headers.hasOwnProperty(a)&&n.push(a);n.sort();n.forEach(function(t){i+=t+":"+(this||e).request.x_amz_headers[t]+"\n"}.bind(this||e));s=(this||e).request.method+"\n"+((this||e).request.md5_digest||"")+"\n"+((this||e).request.contentType||"")+"\n"+"\n"+i+(r.cloudfront?"/"+r.bucket:"")+t.getPath()+(this||e).request.path;o.d("V2 stringToSign:",s);return s};AwsSignatureV2.prototype.dateString=function(e){return this.datetime(e).toUTCString()};AwsSignatureV2.prototype.getPayload=function(){return Promise.resolve()};function AwsSignatureV4(t){(this||e)._cr=void 0;AwsSignature.call(this||e,t)}AwsSignatureV4.prototype=Object.create(AwsSignature.prototype);AwsSignatureV4.prototype.constructor=AwsSignatureV4;AwsSignatureV4.prototype._cr=void 0;AwsSignatureV4.prototype.payload=null;AwsSignatureV4.prototype.error=function(){(this||e)._cr=void 0};AwsSignatureV4.prototype.getPayload=function(){return t.getPayload().then(function(t){(this||e).payload=t}.bind(this||e))};AwsSignatureV4.prototype.authorizationString=function(){var t=[];var o=this.credentialString();var i=this.canonicalHeaders();t.push(["AWS4-HMAC-SHA256 Credential=",r.aws_key,"/",o].join(""));t.push("SignedHeaders="+i.signedHeaders);t.push("Signature="+(this||e).request.auth);return t.join(", ")};AwsSignatureV4.prototype.stringToSign=function(){var t=[];t.push("AWS4-HMAC-SHA256");t.push((this||e).request.dateString);t.push(this.credentialString());t.push(r.cryptoHexEncodedHash256(this.canonicalRequest()));var i=t.join("\n");o.d("V4 stringToSign:",i);return i};AwsSignatureV4.prototype.credentialString=function(){var t=[];t.push((this||e).request.dateString.slice(0,8));t.push(r.awsRegion);t.push("s3");t.push("aws4_request");return t.join("/")};AwsSignatureV4.prototype.canonicalQueryString=function(){var o=t.request.query_string||"",r=uri([t.awsUrl,(this||e).request.path,o].join("")).search,i=r.length?r.split("&"):[],s=[],n,a;for(a=0;a<i.length;a++){n=i[a].split("=");s.push({name:encodeURIComponent(n[0]),value:n.length>1?encodeURIComponent(n[1]):null})}var p=s.sort((function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}));var u=[];for(a=0;a<p.length;a++){n=p[a].value?[p[a].name,p[a].value].join("="):p[a].name+"=";u.push(n)}return u.join("&")};AwsSignatureV4.prototype.getPayloadSha256Content=function(){var t=(this||e).request.contentSha256||r.cryptoHexEncodedHash256((this||e).payload||"");o.d((this||e).request.step,"getPayloadSha256Content:",t);return t};AwsSignatureV4.prototype.canonicalHeaders=function(){var o=[],r=[],i;function addHeader(e,t){var i=e.toLowerCase();r.push(i);o[i]=t.replace(/\s+/g," ")}(this||e).request.md5_digest&&addHeader("Content-Md5",(this||e).request.md5_digest);addHeader("Host",t.awsHost);(this||e).request.contentType&&addHeader("Content-Type",(this||e).request.contentType||"");var s=(this||e).request.x_amz_headers||{};for(var n in s)s.hasOwnProperty(n)&&addHeader(n,s[n]);var a=r.sort((function(e,t){return e<t?-1:e>t?1:0}));var p=[];var u=[],d=(this||e).request.not_signed_headers||[],l=[];for(i=0;i<d.length;i++)u.push(d[i].toLowerCase());for(i=0;i<a.length;i++){var h=a[i];p.push([h,o[h]].join(":"));-1===u.indexOf(h)&&l.push(h)}return{canonicalHeaders:p.join("\n"),signedHeaders:l.join(";")}};AwsSignatureV4.prototype.canonicalRequest=function(){if("undefined"!==typeof(this||e)._cr)return(this||e)._cr;var r=[];r.push((this||e).request.method);r.push(uri([t.awsUrl,t.getPath(),(this||e).request.path].join("")).pathname);r.push(this.canonicalQueryString()||"");var i=this.canonicalHeaders();r.push(i.canonicalHeaders+"\n");r.push(i.signedHeaders);r.push(this.getPayloadSha256Content());(this||e)._cr=r.join("\n");o.d((this||e).request.step,"V4 CanonicalRequest:",(this||e)._cr);return(this||e)._cr};AwsSignatureV4.prototype.setHeaders=function(e){e.setRequestHeader("x-amz-content-sha256",this.getPayloadSha256Content())};return"4"===r.awsSignatureVersion?AwsSignatureV4:AwsSignatureV2}function authorizationMethod(t){var o=t.fileUpload,r=o.con,i=t.request;function AuthorizationMethod(){(this||e).request=i}AuthorizationMethod.prototype=Object.create(AuthorizationMethod.prototype);AuthorizationMethod.prototype.request={};AuthorizationMethod.makeSignParamsObject=function(e){var t={};for(var o in e)e.hasOwnProperty(o)&&("function"===typeof e[o]?t[o]=e[o]():t[o]=e[o]);return t};AuthorizationMethod.prototype.authorize=function(){return new Promise((function(e,s){var n=new XMLHttpRequest;t.currentXhr=n;var a=t.stringToSign(),p=[r.signerUrl,"?to_sign=",a,"&datetime=",i.dateString];if(r.sendCanonicalRequestToSignerUrl){p.push("&canonical_request=");p.push(encodeURIComponent(t.canonicalRequest()))}p=p.join("");var u=AuthorizationMethod.makeSignParamsObject(o.signParams);for(var d in u)u.hasOwnProperty(d)&&(p+="&"+encodeURIComponent(d)+"="+encodeURIComponent(u[d]));r.xhrWithCredentials&&(n.withCredentials=true);n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status)t.signResponse(n.response,a,i.dateString).then(e);else{if([401,403].indexOf(n.status)>-1){var r="status:"+n.status;o.deferredCompletion.reject("Permission denied "+r);return s(r)}s("Signature fetch returned status: "+n.status)}};n.onerror=function(e){s("authorizedSend transport error: "+e.responseText)};n.open("GET",p);var l=AuthorizationMethod.makeSignParamsObject(r.signHeaders);for(var h in l)l.hasOwnProperty(h)&&n.setRequestHeader(h,l[h]);"function"===typeof o.beforeSigner&&o.beforeSigner(n,p);n.send()}))};function AuthorizationCustom(){AuthorizationMethod.call(this||e)}AuthorizationCustom.prototype=Object.create(AuthorizationMethod.prototype);AuthorizationCustom.prototype.authorize=function(){return r.customAuthMethod(AuthorizationMethod.makeSignParamsObject(o.signParams),AuthorizationMethod.makeSignParamsObject(r.signHeaders),t.stringToSign(),i.dateString,t.canonicalRequest()).catch((function(e){o.deferredCompletion.reject(e);throw e}))};return"function"===typeof r.customAuthMethod?new AuthorizationCustom:new AuthorizationMethod}function awsUrl(e){var t;if(e.aws_url)t=[e.aws_url];else{if(e.s3Acceleration){t=["https://",e.bucket,".s3-accelerate"];e.cloudfront=true}else{t=["https://",e.cloudfront?e.bucket+".":"","s3"];"us-east-1"!==e.awsRegion&&t.push("-",e.awsRegion)}t.push(".amazonaws.com")}return t.join("")}function s3EncodedObjectName(e){var t=e.split("/"),o=[];t.forEach((function(e){var t=[],r=encodeURIComponent(e);for(var i=0;i<r.length;i++)t.push(y[r.charCodeAt(i)]||r.charAt(i));o.push(t.join(""))}));return o.join("/")}function uri(e){var t,o=e||"/";try{t=new URL(o)}catch(e){t=document.createElement("a");t.href=o}return{protocol:t.protocol,hostname:t.hostname,pathname:t.pathname.replace(/(^\/?)/,"/"),port:t.port,search:"?"===t.search[0]?t.search.substr(1):t.search,hash:t.hash,host:t.host}}function dateISOString(e){return e?new Date(e).toISOString():""}function getAwsResponse(e){var t=elementText(e.responseText,"Code"),o=elementText(e.responseText,"Message");return t.length?["AWS Code: ",t,", Message:",o].join(""):""}function elementText(e,t){var o=e.match(["<",t,">(.+)</",t,">"].join(""));return o?o[1]:""}function defer(){var e={},t;t=new Promise((function(t,o){e={resolve:t,reject:o}}));return{resolve:e.resolve,reject:e.reject,promise:t}}function extend(e,t,o){function ext(e,t){if("object"===typeof t)for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])}e=e||{};t=t||{};o=o||{};ext(t,o);ext(e,t);return e}function getSavedUploads(e){var t=JSON.parse(v.getItem("awsUploads")||"{}");if(e){for(var i in t)if(t.hasOwnProperty(i)){var s=t[i],n=new Date(s.completedAt||o);n<r&&delete t[i]}v.setItem("awsUploads",JSON.stringify(t))}return t}function uploadKey(e){return[e.file.name,e.file.type,dateISOString(e.file.lastModified),e.sizeBytes].join("-")}function saveUpload(e,t){var o=getSavedUploads();o[e]=t;v.setItem("awsUploads",JSON.stringify(o))}function removeUpload(e){var t=getSavedUploads();delete t[e];v.setItem("awsUploads",JSON.stringify(t))}function removeAtIndex(e,t){var o=e.indexOf(t);if(o>-1){e.splice(o,1);return true}}function readableFileSize(e){var t=["B","Kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"],o=0;while(e>=1024){e/=1024;++o}return[e.toFixed(2).replace(".00",""),t[o]].join(" ")}var v;function HistoryCache(t){var o=HistoryCache.supported();(this||e).cacheStore=t?{}:o?localStorage:void 0}HistoryCache.prototype.supported=false;HistoryCache.prototype.cacheStore=void 0;HistoryCache.prototype.getItem=function(t){if((this||e).cacheStore)return(this||e).cacheStore[t]};HistoryCache.prototype.setItem=function(t,o){(this||e).cacheStore&&((this||e).cacheStore[t]=o)};HistoryCache.prototype.removeItem=function(t){if((this||e).cacheStore)return delete(this||e).cacheStore[t]};HistoryCache.supported=function(){var e=false;if("undefined"===typeof window)return e;if(!("localStorage"in window))return e;try{var t="___test";localStorage[t]="OK";var o=localStorage[t];delete localStorage[t];return"OK"===o}catch(t){return e}};function noOpLogger(){return{d:function(){},w:function(){},e:function(){}}}S=noOpLogger();t?t=Evaporate:"undefined"!==typeof window&&(window.Evaporate=Evaporate)})();var o=t;export default o;

