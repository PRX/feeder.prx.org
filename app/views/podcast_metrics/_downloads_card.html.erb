<%= turbo_frame_tag "downloads" do %>
  <div class="card p-4">
    <div class="card-body">
      <% if episode_rollups.present? %>
        <div class="row d-flex flex-wrap gx-4"
          data-controller="apex"
          data-apex-id-value="<%= SecureRandom.uuid %>"
          data-apex-type-value="line"
          data-apex-series-value="<%= parse_episode_downloads(episode_rollups, date_start, date_end).to_json %>">
          <div class="col">
            <div data-apex-target="chart"></div>
          </div>
          <div class="col align-items-center">
            <div class="col my-4">
              <table class="table table-striped shadow rounded">
                <thead>
                  <tr class="table-secondary">
                    <th>Episode</th>
                    <th>Publish Date</th>
                    <th>Downloads</th>
                    <th>All-time</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="fw-bold">All Episodes</td>
                    <td></td>
                    <td class="fw-bold"><%= total_recent.first[:count] %></td>
                    <td class="fw-bold"><%= total_alltime.first[:count] %></td>
                  </tr>
                  <% episode_rollups.each_with_index do |er, i| %>
                    <% @sum = sum_rollups(er[:rollups]) %>
                    <% @total = sum_rollups(er[:totals]) %>
                    <% @title = er[:ep][:title] %>
                    <tr class="align-items-center">
                      <td class="d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-2" checked="true" data-action="click->apex#toggleSeries" data-series="<%= @title %>">
                        <span class="material-icons me-2" aria-label="hidden" style="color: <%= line_chart_colors[i] %>">circle</span>
                        <span><%= @title %></span>
                      </td>
                      <td><%= er[:ep][:published_at].strftime("%Y-%m-%d") %></td>
                      <td><% if @sum %><%= @sum %><% else %>&mdash;<% end %></td>
                      <td><% if @total %><%= @total %><% else %>&mdash;<% end %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <div class="col my-4">
              <%= paginate episodes %>
            </div>
          </div>
        </div>
      <% else %>
        No data to display.
      <% end %>
    </div>
  </div>
<% end %>
