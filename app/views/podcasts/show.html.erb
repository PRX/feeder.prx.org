<% content_for :title, @podcast.title %>

<div class="my-4">
  <div class="d-grid d-sm-flex align-items-center">
    <div class="d-flex align-items-center flex-fill">
      <%= cache [@podcast, :show_image] do %>
        <div>
          <% if @podcast.ready_image %>
            <%= image_tag(@podcast.ready_image.url, width: 135, alt: @podcast.ready_image.alt_text, class: "d-flex me-4") %>
          <% end %>
        </div>
        <div class="flex-fill">
          <h1 class="fw-bold lh-1"><%= @podcast.title %></h1>
          <%= @podcast.subtitle %>
        </div>
      <% end %>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <% if policy(@podcast).update? %>
        <%= link_to new_podcast_episode_path(@podcast), class: "btn btn-primary btn-sm" do %>
          <%= t ".create_episode" %>
          <span class="material-icons ms-2" aria-hidden="true">mic</span>
        <% end %>
        <%= link_to podcast_planner_path(@podcast), class: "btn btn-primary btn-sm" do %>
          <%= t ".plan_episodes" %>
          <span class="material-icons ms-2" aria-hidden="true">calendar_today</span>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="row my-4">
    <div class="d-flex flex-column col-lg-4 mb-4 mb-lg-0">
      <div class="card shadow border-0 mb-4 flex-fill">
        <div class="card-header-primary d-flex gap-4 align-items-center">
          <h2 class="h4 episode-card-title fw-bold flex-fill mb-0"><%= t ".latest_published" %></h2>
          <%= link_to podcast_episodes_path(@podcast), class: "btn btn-light btn-sm" do %>
            <%= t ".all_episodes" %>
            <span class="material-icons" aria-label="hidden">keyboard_arrow_right</span>
          <% end %>
        </div>
        <div class="card-body episode-card mb-0 h-auto border-start-0 p-0 d-flex flex-column metrics-episodes-card">
          <% if @recently_published_episodes.present? %>
            <% @recently_published_episodes.each do |episode| %>
              <%= render "metrics/episode_card", podcast: @podcast, episode: episode %>
            <% end %>
          <% else %>
            <p class="text-muted text-center m-2"><%= t(".no_published") %></p>
          <% end %>
        </div>
      </div>

      <div class="card shadow border-0 flex-fill">
        <div class="card-header-warning d-flex align-items-center">
          <h2 class="h4 episode-card-title fw-bold flex-fill mb-0"><%= t ".next_scheduled" %></h2>
        </div>
        <div class="card-body episode-card mb-0 h-auto border-start-0 p-0 d-flex flex-column metrics-episodes-card">
          <% if @next_scheduled_episodes.present? %>
            <% @next_scheduled_episodes.each do |ep| %>
              <div class="episode-card-info inside-card flex-fill px-3 episode-row">
                <p class="episode-card-date episode-card-text">
                  <% if ep.published_or_released_date.present? %>
                    <%= local_date(ep.published_or_released_date, format: :short) %>
                  <% end %>
                </p>
                <div class="episode-card-inner inside-card">
                  <h2 class="h5 episode-card-title episode-card-text"><%= link_to ep.title, episode_path(ep) %></h2>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted text-center m-2"><%= t(".no_scheduled") %></p>
          <% end %>
        </div>
      </div>
    </div>

    <% if show_metrics? %>
      <div class="col-lg-8 d-flex">
        <%= render "scorecard_dashboard", podcast: @podcast %>
      </div>
    <% else %>
      <div class="col-lg-4 d-grid mb-4 mb-lg-0">
        <div class="prx-dashboard-card card shadow border-0">
          <div class="card-header-light d-flex align-items-center">
            <h2 class="h4 episode-card-title fw-bold flex-fill mb-0"><%= t ".feeds" %></h2>
            <%= link_to podcast_feeds_path(@podcast), class: "btn btn-primary btn-sm" do %>
              <%= t ".manage_feeds" %>
              <span class="material-icons" aria-label="hidden">keyboard_arrow_right</span>
            <% end %>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <% @feeds.each do |feed| %>
                <li class="list-group-item border-bottom-0 p-0"><%= link_to feed.label, podcast_feed_path(@podcast, feed) %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>

      <div class="col-lg-4 d-grid">
        <div class="prx-dashboard-card card shadow border-0">
          <div class="card-header-light d-flex align-items-center">
            <h2 class="h4 episode-card-title fw-bold flex-fill mb-0"><%= t ".settings" %></h2>
            <%= link_to edit_podcast_path(@podcast), class: "btn btn-primary btn-sm" do %>
              <%= t(".manage_settings") %>
              <span class="material-icons" aria-label="hidden">keyboard_arrow_right</span>
            <% end %>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item border-bottom-0 p-0"><%= link_to t(".engagement_settings"), podcast_engagement_path(@podcast) %></li>
              <li class="list-group-item border-bottom-0 p-0"><%= link_to t(".player"), podcast_player_path(@podcast) %></li>
              <li class="list-group-item border-bottom-0 p-0"><%= link_to t(".import"), podcast_imports_path(@podcast) %></li>
            </ul>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <% if show_metrics? %>
    <div class="row">
      <% if uses_multiple_feeds(@podcast) %>
        <div class="col-lg-6 d-grid mb-4">
          <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="h4 fw-bold mb-0"><%= t(".by_feed") %></span>
              <span><%= t(".last_28") %></span>
            </div>
            <div class="card-body p-0 metrics-bar-list">
              <%= turbo_frame_tag "feeds", src: feeds_podcast_metrics_path(podcast_id: @podcast.id), loading: "lazy", target: "_top" do %>
                <%= render "metrics/loading_card" %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
      <% if uses_seasons(@podcast) %>
        <div class="col-lg-6 d-grid mb-4">
          <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="h4 fw-bold mb-0"><%= t(".by_season") %></span>
              <span><%= t(".alltime") %></span>
            </div>
            <div class="card-body p-0 metrics-bar-list">
              <%= turbo_frame_tag "seasons", src: seasons_podcast_metrics_path(podcast_id: @podcast.id), loading: "lazy" do %>
                <%= render "metrics/loading_card" %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
      <div class="col-lg-6 d-grid mb-4">
        <div class="card shadow">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="h4 fw-bold mb-0"><%= t(".by_country") %></span>
            <span><%= t(".last_28") %></span>
          </div>
          <div class="card-body p-0 metrics-bar-list">
            <%= turbo_frame_tag "countries", src: countries_podcast_metrics_path(podcast_id: @podcast.id), loading: "lazy" do %>
              <%= render "metrics/loading_card" %>
            <% end %>
          </div>
        </div>
      </div>
      <div class="col-lg-6 d-grid mb-4">
        <div class="card shadow">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="h4 fw-bold mb-0"><%= t(".by_app") %></span>
            <span><%= t(".last_28") %></span>
          </div>
          <div class="card-body p-0 metrics-bar-list">
            <%= turbo_frame_tag "agents", src: agents_podcast_metrics_path(podcast_id: @podcast.id), loading: "lazy" do %>
              <%= render "metrics/loading_card" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
